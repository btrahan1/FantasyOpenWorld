@page "/"
@inject IJSRuntime JS

<div class="game-container">
    <canvas id="renderCanvas"></canvas>
    
    @if (ShowSplash)
    {
        <div class="splash-overlay">
            <h1 class="splash-title">FANTASY<br>OPEN WORLD</h1>
            <button class="start-btn" @onclick="StartGame">ENTER THE REALM</button>
            <p class="controls-hint">Use WASD to Move | Click to Attack</p>
        </div>
    }
    else
    {
        <div class="hud-top-left">
            <div class="bar-container">
                <div id="healthBar" class="health-bar"></div>
                <span class="bar-label">HP</span>
            </div>
        </div>

        <div class="hud-top-center" id="targetInfo" style="display:none;">
            <h3 id="targetName">TARGET</h3>
            <div class="bar-container small">
                <div id="targetHealthBar" class="health-bar red"></div>
            </div>
        </div>

        <div class="hud-top-right">
            <canvas id="radarCanvas" width="150" height="150"></canvas>
        </div>
    }
</div>

<script>
    // ... hud update script ...
    window.focusGame = () => {
        document.getElementById("renderCanvas").focus();
    };
    
    window.updateHud = (hp, maxHp, targetName, targetHp, targetMaxHp, mobs, playerPos, playerRot) => {
        // ... previous hud logic ...
        // Player Health
        var hpPct = (hp / maxHp) * 100;
        var hpBar = document.getElementById('healthBar');
        if(hpBar) hpBar.style.width = hpPct + "%";
        
        // Target Info
        var targetPanel = document.getElementById('targetInfo');
        if(targetPanel) {
            if(targetName) {
                targetPanel.style.display = "block";
                document.getElementById('targetName').innerText = targetName;
                var tHpPct = (targetHp / targetMaxHp) * 100;
                document.getElementById('targetHealthBar').style.width = tHpPct + "%";
            } else {
                targetPanel.style.display = "none";
            }
        }

        // Radar
        var canvas = document.getElementById('radarCanvas');
        if(canvas) {
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 150, 150);
            
            // Background
            ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
            ctx.beginPath();
            ctx.arc(75, 75, 70, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#444";
            ctx.stroke();

            // Player (Center Arrow)
            ctx.save();
            ctx.translate(75, 75);
            ctx.rotate(-playerRot + Math.PI); // Rotate world around player
            
            // Draw Mobs
            if(mobs) {
                mobs.forEach(m => {
                    var dx = m.x - playerPos.x;
                    var dz = m.z - playerPos.z;
                    // Scale down distance
                    var rX = dx * 2; 
                    var rZ = dz * 2;
                    
                    if(rX*rX + rZ*rZ < 70*70) {
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(rX, -rZ, 3, 0, Math.PI*2); // Flip Z because Canvas Y is down
                        ctx.fill();
                    }
                });
            }

            ctx.restore();

            // Player Icon (Always center, pointing up)
            ctx.fillStyle = "lime";
            ctx.beginPath();
            ctx.moveTo(75, 70);
            ctx.lineTo(80, 80);
            ctx.lineTo(70, 80);
            ctx.fill();
        }
    };
</script>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');

    .game-container { position: relative; width: 100%; height: 100vh; background: #000; }
    #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; display: block; }

    /* Splash Screen */
    .splash-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }
    
    .splash-title {
        font-family: 'Cinzel', serif;
        font-size: 80px;
        color: #e0c060; /* Gold */
        text-shadow: 0 0 10px #000, 0 0 20px #806000;
        text-align: center;
        margin-bottom: 50px;
        letter-spacing: 5px;
    }

    .start-btn {
        padding: 15px 40px;
        font-family: 'Cinzel', serif;
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        background: #800000; /* Dark Red */
        border: 2px solid #e0c060;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    
    .start-btn:hover {
        background: #a00000;
        transform: scale(1.05);
        box-shadow: 0 0 25px rgba(224, 192, 96, 0.5);
    }
    
    .controls-hint {
        margin-top: 30px;
        color: #ccc;
        font-family: sans-serif;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    /* HUD */
    .hud-top-left { position: absolute; top: 20px; left: 20px; width: 200px; }
    .hud-top-center { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; color: white; font-family: sans-serif; text-shadow: 1px 1px 0 #000; }
    .hud-top-right { position: absolute; top: 20px; right: 20px; }

    .bar-container { width: 100%; height: 20px; background: #333; border: 2px solid #555; position: relative; }
    .bar-container.small { width: 150px; height: 10px; margin: 0 auto; }
    
    .health-bar { height: 100%; background: lime; transition: width 0.1s; }
    .health-bar.red { background: red; }
    
    .bar-label { position: absolute; top: -20px; left: 0; color: white; font-weight: bold; font-family: sans-serif; font-size: 12px; }
    
    #targetName { margin: 0 0 5px 0; font-size: 16px; letter-spacing: 1px; }
</style>

@code {
    private bool ShowSplash { get; set; } = true;

    private void StartGame()
    {
        ShowSplash = false;
        // Focus the canvas
        _ = JS.InvokeVoidAsync("focusGame");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("gameEngine.initGame", "renderCanvas");
        }
    }
}
